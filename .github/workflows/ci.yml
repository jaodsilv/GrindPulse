name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: ['18.x', '20.x']
      # fail-fast: false ensures we see test results for ALL Node versions,
      # not just the first one that fails. This helps identify version-specific issues.
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Install test dependencies
        working-directory: tests
        run: npm ci

      - name: Run tests with coverage
        working-directory: tests
        run: npm run test:coverage

      - name: Upload coverage report
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: tests/coverage/
          retention-days: 7

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request' && matrix.node-version == '20.x'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const coverageSummaryPath = 'tests/coverage/coverage-summary.json';

            if (!fs.existsSync(coverageSummaryPath)) {
              console.log('Coverage summary not found');
              return;
            }

            const coverageSummary = JSON.parse(
              fs.readFileSync(coverageSummaryPath, 'utf8')
            );
            const total = coverageSummary.total;

            const comment = [
              '## Coverage Report',
              '',
              '| Metric | Coverage |',
              '|--------|----------|',
              `| Lines | ${total.lines.pct}% |`,
              `| Statements | ${total.statements.pct}% |`,
              `| Functions | ${total.functions.pct}% |`,
              `| Branches | ${total.branches.pct}% |`,
              '',
              '*Coverage threshold: 90%*'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test-python:
    name: Python Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install test dependencies
        run: pip install pytest pytest-cov

      - name: Run Python tests with coverage
        run: pytest tests/python -v --cov=. --cov-report=xml --cov-report=term-missing --cov-fail-under=90

      - name: Upload Python coverage report
        if: matrix.python-version == '3.12'
        uses: actions/upload-artifact@v6
        with:
          name: python-coverage-report
          path: coverage.xml
          retention-days: 7

  build:
    name: Build (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [test, test-python]

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
      # fail-fast: false ensures we see build results for ALL Python versions,
      # not just the first one that fails. This helps identify version-specific issues.
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build tracker.html
        run: python build_tracker.py

      - name: Verify output and track size
        id: size
        run: |
          if [ ! -f tracker.html ]; then
            echo "Error: tracker.html was not generated"
            exit 1
          fi
          SIZE=$(stat -c%s tracker.html)
          SIZE_KB=$(echo "scale=2; $SIZE / 1024" | bc)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "size_kb=$SIZE_KB" >> $GITHUB_OUTPUT
          echo "tracker.html size: ${SIZE_KB}KB ($SIZE bytes)"
          echo "Build successful with Python ${{ matrix.python-version }}"
          echo "## Build Size: ${SIZE_KB}KB" >> $GITHUB_STEP_SUMMARY

      - name: Comment build size on PR
        if: github.event_name == 'pull_request' && matrix.python-version == '3.12'
        uses: actions/github-script@v8
        with:
          script: |
            const sizeKb = '${{ steps.size.outputs.size_kb }}';
            const body = `## Build Size\n\n**tracker.html:** ${sizeKb}KB\n\n*Built with Python 3.12*`;

            // Find existing build size comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('## Build Size')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload tracker.html artifact
        if: matrix.python-version == '3.12'
        uses: actions/upload-artifact@v6
        with:
          name: tracker-html
          path: tracker.html
          retention-days: 30

  # Firebase validation runs in parallel with test job
  validate-firebase-config:
    name: Validate Firebase Config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for Firebase config
        id: check-firebase
        run: |
          if [ -f firebase_config.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No firebase_config.json found (optional feature disabled)"
          fi

      - name: Validate Firebase config schema
        if: steps.check-firebase.outputs.exists == 'true'
        run: |
          python3 << 'EOF'
          import json
          import sys

          required_fields = [
              'apiKey',
              'authDomain',
              'projectId',
              'storageBucket',
              'messagingSenderId',
              'appId'
          ]

          with open('firebase_config.json', 'r') as f:
              config = json.load(f)

          # Check for missing required fields
          missing = [field for field in required_fields if field not in config]
          if missing:
              print(f'Error: Missing required fields: {missing}')
              sys.exit(1)

          # Check for placeholder values
          placeholders = ['YOUR_', 'REPLACE_', 'TODO', 'PLACEHOLDER']
          warnings = []
          for field, value in config.items():
              if any(p in str(value).upper() for p in placeholders):
                  warnings.append(f'{field} appears to contain a placeholder value')

          if warnings:
              print('Warnings:')
              for w in warnings:
                  print(f'  - {w}')
              print('\nNote: Placeholder values detected. Ensure real values are used in production.')

          print('Firebase config validation passed!')
          EOF

  # Overall CI status check
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [test, test-python, build, validate-firebase-config]
    if: always()
    steps:
      - name: Check CI status
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| JS Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.test-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Firebase Config | ${{ needs.validate-firebase-config.result }} |" >> $GITHUB_STEP_SUMMARY

          # NOTE: Firebase validation failures don't fail CI because Firebase is optional.
          # The validate-firebase-config job is informational only - it helps catch
          # config issues but doesn't block PRs since the app works without Firebase.
          if [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.test-python.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo ""
            echo "CI failed - see job logs for details"
            exit 1
          fi

          echo ""
          echo "All CI checks passed!"
