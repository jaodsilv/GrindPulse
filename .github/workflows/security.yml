name: Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

permissions:
  contents: read
  security-events: write

jobs:
  # Secret Detection with Gitleaks
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Dependency Vulnerability Scanning
  dependency-scan:
    name: Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Install dependencies
        working-directory: tests
        run: npm ci

      - name: Run npm audit
        working-directory: tests
        # NOTE: || true is intentional - npm audit failures are tracked via artifacts
        # and GitHub Security tab (via SARIF), not workflow failures.
        # This allows security scanning without blocking all PRs.
        # Critical issues (secrets) are still caught by secret-scan job which does fail.
        run: |
          npm audit --audit-level=moderate --json > ../npm-audit.json || true
          npm audit --audit-level=moderate || echo "::warning::npm audit found vulnerabilities - see artifacts and Security tab"

      - name: Upload npm audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: npm-audit.json
          retention-days: 7

  # SAST for Python with Bandit
  python-sast:
    name: Python SAST (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit
        # NOTE: || true is intentional - Bandit findings are tracked via SARIF upload
        # to GitHub Security tab, not workflow failures. This allows security scanning
        # without blocking PRs. Critical issues (secrets) are caught by secret-scan job.
        run: |
          # Check if there are Python files to scan
          if find . -name "*.py" -not -path "./tests/*" -not -path "./.git/*" -not -path "./node_modules/*" | grep -q .; then
            bandit -r . -f sarif -o bandit-results.sarif \
              --exclude ./tests,./node_modules,./__pycache__,./.git \
              --severity-level medium || true
          else
            echo "No Python files found to scan"
          fi

          # Create empty SARIF file if it doesn't exist (no findings or no files)
          if [ ! -f bandit-results.sarif ]; then
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Bandit","version":"1.7.0"}},"results":[]}]}' > bandit-results.sarif
          fi

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: bandit-results.sarif

  # CodeQL Analysis (comprehensive)
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python, javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python,javascript"

  # Security status summary
  security-status:
    name: Security Status
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, python-sast, codeql]
    if: always()
    steps:
      - name: Check security status
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python SAST | ${{ needs.python-sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.secret-scan.result }}" == "failure" ]]; then
            echo ""
            echo "**CRITICAL: Secrets detected in repository!**"
            exit 1
          fi

          echo ""
          echo "Security scans completed - review findings in Security tab"
